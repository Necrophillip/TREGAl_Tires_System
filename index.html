<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TREGAL Tires — Centro de Servicio</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg: #0f172a;           /* slate-900 */
  --panel: #111827;        /* gray-900 */
  --panel-2:#0b1220;
  --text: #e5e7eb;         /* gray-200 */
  --muted:#9ca3af;         /* gray-400 */
  --brand:#2dd4bf;         /* teal-400 */
  --brand-2:#22c55e;       /* green-500 */
  --danger:#ef4444;
  --warn:#f59e0b;
  --ok:#10b981;
  --card:#0b1328;
  --stroke:#1f2937;
  --chip:#111827;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
  --radius: 14px;
  --radius-sm: 10px;
}
:root[data-theme="light"]{
  --bg: #f4f6fb;
  --panel: #ffffff;
  --panel-2:#f8fafc;
  --text:#0f172a;
  --muted:#6b7280;
  --brand:#2563eb;         /* blue-600 */
  --brand-2:#7c3aed;       /* violet-600 */
  --card:#ffffff;
  --stroke:#e5e7eb;
  --chip:#f1f5f9;
  --shadow: 0 10px 30px rgba(2,6,23,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  color:var(--text); background:linear-gradient(180deg,var(--bg),var(--panel-2) 60%);
}

/* Layout */
.app{
  display:grid; grid-template-columns: 280px 1fr; grid-template-rows: 72px 1fr;
  grid-template-areas: "sidebar topbar" "sidebar main"; min-height:100dvh;
}
.sidebar{
  grid-area:sidebar; position:sticky; top:0; height:100dvh; padding:22px 16px;
  background:linear-gradient(180deg,rgba(255,255,255,.06),transparent), var(--panel);
  border-right:1px solid var(--stroke);
}
.topbar{
  grid-area:topbar; display:flex; align-items:center; gap:12px; padding:14px 18px;
  position:sticky; top:0; backdrop-filter:saturate(180%) blur(8px);
  background:linear-gradient(180deg,rgba(255,255,255,.35),rgba(255,255,255,0)) ;
  border-bottom:1px solid var(--stroke);
}
main{ grid-area:main; padding:22px; }

/* Sidebar */
.brand{
  display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.2px; margin-bottom:18px;
}
.brand .logo{
  width:40px; height:40px; display:grid; place-items:center; border-radius:12px;
  background: radial-gradient(120px 60px at -10% -20%, var(--brand-2), transparent 60%),
              radial-gradient(120px 60px at 120% 120%, var(--brand), transparent 60%),
              linear-gradient(140deg, var(--panel-2), var(--panel));
  color:white; box-shadow: var(--shadow); border:1px solid var(--stroke);
}
.nav{display:flex; flex-direction:column; gap:6px; margin-top:8px;}
.nav a{
  display:flex; align-items:center; gap:12px; padding:12px 12px; border-radius:12px;
  color:var(--text); text-decoration:none; border:1px solid transparent;
}
.nav a.active, .nav a:hover{
  background:linear-gradient(180deg, var(--chip), transparent 70%);
  border-color: var(--stroke);
}
.nav .icon{width:20px; height:20px; opacity:.9}

/* Topbar */
.search{
  display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--stroke);
  background:var(--panel); color:var(--muted); border-radius:12px; min-width:320px; flex:1;
}
.search input{all:unset; color:var(--text); width:100%;}
.kbd{
  font-size:12px; padding:2px 6px; border:1px solid var(--stroke); border-radius:6px; background:var(--chip); color:var(--muted);
}
.actions{display:flex; align-items:center; gap:10px; margin-left:auto;}
.btn{
  display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border:1px solid var(--stroke);
  background:var(--panel); color:var(--text); border-radius:10px; cursor:pointer;
}
.btn.primary{ background: linear-gradient(180deg,var(--brand),var(--brand-2)); color:white; border-color:transparent; }
.btn.ghost:hover{ background:var(--chip); }
.avatar{width:34px; height:34px; border-radius:50%; border:1px solid var(--stroke); background:linear-gradient(180deg,var(--chip),transparent)}

/* Cards & grids */
.grid{ display:grid; gap:16px; }
.kpi{ background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow)}
.kpi h4{ margin:0 0 6px; font-weight:700; }
.kpi .trend{font-size:12px; color:var(--muted)}
.kpi .value{ font-size:28px; font-weight:800; letter-spacing:.2px; }
.row-3{ grid-template-columns: repeat(3, minmax(0,1fr)); }
.row-2{ grid-template-columns: repeat(2, minmax(0,1fr)); }

/* Panels */
.panel{
  background:var(--panel); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow);
}
.panel header{
  padding:14px 16px; display:flex; align-items:center; gap:10px; border-bottom:1px solid var(--stroke);
}
.panel header h3{ margin:0; font-weight:800; font-size:16px; }
.panel .body{ padding:16px; }

/* Tables */
.table{ width:100%; border-collapse:collapse;}
.table th, .table td{ padding:10px 12px; border-bottom:1px solid var(--stroke); text-align:left; }
.table th{ font-size:12px; color:var(--muted); font-weight:600; letter-spacing:.3px; text-transform:uppercase; }
.table tr:hover td{ background:linear-gradient(180deg,var(--chip),transparent); }

/* Form */
.form-grid{ display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; }
.field{ display:flex; flex-direction:column; gap:6px; }
.field label{ font-size:12px; color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:.3px; }
.input, select, textarea{
  padding:10px 12px; border:1px solid var(--stroke); background:var(--panel-2);
  border-radius:10px; color:var(--text); outline:none;
}
.input:focus, select:focus, textarea:focus{ border-color: var(--brand); box-shadow:0 0 0 4px color-mix(in srgb, var(--brand) 20%, transparent); }

/* Items table */
.items{ width:100%; border-collapse:collapse; margin-top:10px; }
.items th, .items td{ border-bottom:1px solid var(--stroke); padding:8px; }
.items th{ font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.3px; }
.items input{ width:100%; }
.row-actions .mini{ padding:6px 8px; font-size:12px; border-radius:8px; border:1px solid var(--stroke); background:var(--chip); cursor:pointer }
.badge{font-size:12px; padding:4px 8px; background:var(--chip); border:1px solid var(--stroke); border-radius:999px; color:var(--muted)}

/* Totals */
.totals{ display:grid; grid-template-columns: 1fr 360px; gap:16px; align-items:start; }
.tot-card{ background:var(--card); border:1px solid var(--stroke); border-radius:12px; padding:14px; }
.tot-row{ display:flex; justify-content:space-between; margin:6px 0; color:var(--muted); }
.tot-row strong{ color:var(--text) }
.tot-grand{ display:flex; justify-content:space-between; margin-top:10px; font-size:22px; font-weight:800; }

/* Modal */
.modal-backdrop{
  position:fixed; inset:0; background:rgba(2,6,23,.55); display:none; place-items:center; padding:20px; z-index:60;
}
.modal{ background:var(--panel); border:1px solid var(--stroke); border-radius:16px; width:min(920px, 96vw); box-shadow:var(--shadow); }
.modal header{ padding:14px 16px; border-bottom:1px solid var(--stroke); display:flex; align-items:center; justify-content:space-between }
.modal .content{ padding:16px; }
.modal .footer{ padding:12px 16px; border-top:1px solid var(--stroke); display:flex; justify-content:flex-end; gap:10px }

/* Utilities */
.hidden{display:none !important}
.right{margin-left:auto}
hr.sep{border:0; border-top:1px dashed var(--stroke); margin:8px 0}
small.help{color:var(--muted)}
/* Responsive */
@media (max-width: 1100px){
  .app{ grid-template-columns: 88px 1fr; }
  .sidebar .label{ display:none; }
  .row-3{ grid-template-columns: 1fr; }
  .row-2{ grid-template-columns: 1fr; }
  .form-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
  .totals{ grid-template-columns: 1fr; }
}
@media print {
  .sidebar,.topbar,.no-print{ display:none !important; }
  main{ padding:0 }
  body{ background:white }
  .panel, .kpi, .tot-card{ box-shadow:none; border:1px solid #cbd5e1 }
}
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <!-- TREGAL Tires Logo -->
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <circle cx="12" cy="12" r="4"></circle>
          <line x1="22" y1="12" x2="18" y2="12"></line>
          <line x1="6" y1="12" x2="2" y2="12"></line>
          <line x1="12" y1="2" x2="12" y2="6"></line>
          <line x1="12" y1="18" x2="12" y2="22"></line>
        </svg>
      </div>
      <span>TREGAL Tires</span>
    </div>
    <nav class="nav">
      <a href="#" class="active" data-page="dashboard">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" stroke="currentColor" stroke-width="1.5"/></svg>
        <span class="label">Dashboard</span>
      </a>
      <a href="#" data-page="quotes">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M4 6h16M4 12h10M4 18h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><rect x="3" y="4" width="18" height="16" rx="3" stroke="currentColor" stroke-width="1.5"/></svg>
        <span class="label">Cotizaciones</span>
      </a>
      <a href="#" data-page="workorders">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M4 7h16M4 12h16M4 17h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M7 3h10a2 2 0 0 1 2 2v14l-4-3-4 3-4-3-4 3V5a2 2 0 0 1 2-2z" stroke="currentColor" stroke-width="1.5"/></svg>
        <span class="label">Órdenes</span>
      </a>
      <a href="#" data-page="clients">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="1.5"/><circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="1.5"/></svg>
        <span class="label">Clientes</span>
      </a>
      <a href="#" data-page="vehicles">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 13l2-6h14l2 6" stroke="currentColor" stroke-width="1.5"/><circle cx="7" cy="17" r="2.5" stroke="currentColor" stroke-width="1.5"/><circle cx="17" cy="17" r="2.5" stroke="currentColor" stroke-width="1.5"/></svg>
        <span class="label">Vehículos</span>
      </a>
      <a href="#" data-page="inventory">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 7l9-4 9 4-9 4-9-4z" stroke="currentColor" stroke-width="1.5"/><path d="M3 7v10l9 4 9-4V7" stroke="currentColor" stroke-width="1.5"/></svg>
        <span class="label">Inventario</span>
      </a>
      <a href="#" data-page="reports">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M4 19h16M8 17V7M12 17V5M16 17v-6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        <span class="label">Reportes</span>
      </a>
      <a href="#" data-page="payrolls">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path stroke="currentColor" stroke-width="1.5" d="M17 9.5a.5.5 0 01.5-.5h1a.5.5 0 01.5.5v5a.5.5 0 01-.5.5h-1a.5.5 0 01-.5-.5v-5zM14 9.5a.5.5 0 01.5-.5h1a.5.5 0 01.5.5v5a.5.5 0 01-.5.5h-1a.5.5 0 01-.5-.5v-5zM3 8a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 1.5a.5.5 0 01.5-.5h1a.5.5 0 01.5.5v5a.5.5 0 01-.5-.5h-1a.5.5 0 01-.5-.5v-5z"></path></svg>
        <span class="label">Nóminas</span>
      </a>
      <hr class="sep">
      <a href="#" id="toggleTheme">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 3v2m0 14v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M3 12h2m14 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        <span class="label">Tema</span>
      </a>
    </nav>
  </aside>

  <!-- Topbar -->
  <header class="topbar">
    <div class="search" role="search">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.5"/><path d="M21 21l-3.5-3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      <input type="search" id="globalSearch" placeholder="Buscar cliente, placa, VIN, cotización…" />
      <span class="kbd">/</span>
    </div>
    <div class="actions">
      <button class="btn ghost no-print" id="newQuoteBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
        Nueva cotización
      </button>
      <button class="btn primary no-print" id="exportDemo">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 16V4m0 12l-4-4m4 4l4-4M5 20h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
        Exportar PDF (demo)
      </button>
      <img class="avatar" alt="Usuario" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='34' height='34'><rect width='34' height='34' rx='17' fill='%23ddd'/></svg>"/>
    </div>
  </header>

  <!-- Main -->
  <main>
    <!-- DASHBOARD -->
    <section id="page-dashboard">
      <div class="grid row-3">
        <div class="kpi">
          <h4>Ingresos mes</h4>
          <div class="value" id="kpiIngresos">$0</div>
          <div class="trend">+12.4% vs. mes anterior</div>
        </div>
        <div class="kpi">
          <h4>Órdenes activas</h4>
          <div class="value" id="kpiOrdenes">0</div>
          <div class="trend"><span class="badge">Taller</span> Aforo 65%</div>
        </div>
        <div class="kpi">
          <h4>Índice de retorno</h4>
          <div class="value">1.8%</div>
          <div class="trend">Objetivo &lt; 3%</div>
        </div>
      </div>

      <div class="grid row-2" style="margin-top:16px">
        <div class="panel">
          <header><h3>Últimas cotizaciones</h3></header>
          <div class="body">
            <table class="table" id="quotesTable">
              <thead>
                <tr><th>Folio</th><th>Cliente</th><th>Vehículo</th><th>Fecha</th><th>Total</th><th>Estatus</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="panel">
          <header><h3>Alertas de inventario</h3></header>
          <div class="body" id="inventoryAlerts">
            <div class="badge">Sin alertas por ahora</div>
          </div>
        </div>
      </div>
    </section>

    <!-- COTIZACIONES -->
    <section id="page-quotes" class="hidden">
      <div class="panel">
        <header>
          <h3>Generador de Cotizaciones</h3>
          <div class="right">
            <button class="btn ghost no-print" id="btnSelectClient">Seleccionar cliente</button>
            <button class="btn ghost no-print" id="btnSelectVehicle">Seleccionar vehículo</button>
          </div>
        </header>
        <div class="body">
          <div class="form-grid">
            <div class="field"><label>Folio</label><input class="input" id="qFolio" placeholder="AUT-0001"/></div>
            <div class="field"><label>Fecha</label><input class="input" id="qFecha" type="date"/></div>
            <div class="field"><label>Validez (días)</label><input class="input" id="qValidez" type="number" value="7"/></div>
            <div class="field"><label>Moneda</label>
              <select id="qMoneda">
                <option value="MXN">MXN</option>
                <option value="USD">USD</option>
              </select>
            </div>

            <div class="field"><label>Cliente</label><input class="input" id="qCliente" placeholder="Nombre / Razón Social" /></div>
            <div class="field"><label>RFC</label><input class="input" id="qRFC" placeholder="RFC"/></div>
            <div class="field"><label>Correo</label><input class="input" id="qEmail" type="email" placeholder="correo@cliente.com" /></div>
            <div class="field"><label>Teléfono</label><input class="input" id="qPhone" placeholder="+52 ..."/></div>

            <div class="field"><label>Vehículo</label><input class="input" id="qVehiculo" placeholder="Marca Modelo Año"/></div>
            <div class="field"><label>Placas</label><input class="input" id="qPlacas" placeholder="XYZ-123-A"/></div>
            <div class="field"><label>VIN</label><input class="input" id="qVIN" placeholder="17 caracteres"/></div>
            <div class="field"><label>KM</label><input class="input" id="qKM" type="number" placeholder="Kilometraje"/></div>
          </div>

          <hr class="sep">
          <div class="row" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
            <span class="badge">Items de cotización</span>
            <button class="btn ghost no-print" id="addItemBtn">+ Agregar</button>
            <small class="help">Usa <strong>Refacciones</strong> o <strong>Mano de Obra</strong>. Aplica descuento por renglón si lo necesitas.</small>
          </div>

          <table class="items" id="itemsTable" aria-label="Tabla de conceptos">
            <thead>
              <tr>
                <th style="width:120px">Tipo</th>
                <th>Descripción</th>
                <th style="width:100px">Cant.</th>
                <th style="width:140px">P. Unit.</th>
                <th style="width:110px">Desc. %</th>
                <th style="width:120px">IVA</th>
                <th style="width:140px">Importe</th>
                <th style="width:70px" class="no-print">Acción</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div class="totals" style="margin-top:16px">
            <div class="notes">
              <div class="field">
                <label>Notas / Alcance</label>
                <textarea id="qNotas" rows="5" placeholder="Vigencia 7 días. Precios sujetos a cambio sin previo aviso. No incluye piezas no listadas, etc."></textarea>
              </div>
              <div class="field">
                <label>Condiciones</label>
                <textarea id="qCond" rows="3" placeholder="50% anticipo en refacciones. Saldo contra entrega. Garantía 90 días mano de obra."></textarea>
              </div>
            </div>
            <div class="tot-card">
              <div class="tot-row"><span>Subtotal</span><strong id="tSubtotal">$0.00</strong></div>
              <div class="tot-row"><span>Descuento</span><strong id="tDescuento">$0.00</strong></div>
              <div class="tot-row"><span>IVA 16%</span><strong id="tIVA">$0.00</strong></div>
              <hr class="sep">
              <div class="tot-grand"><span>Total</span><span id="tTotal">$0.00</span></div>
              <div style="display:flex; gap:8px; margin-top:12px" class="no-print">
                <button class="btn ghost" id="saveQuote">Guardar</button>
                <button class="btn primary" id="postBackend">Enviar a backend (POST)</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- PLACEHOLDER PAGES -->
    <section id="page-workorders" class="hidden">
      <div class="panel"><header><h3>Órdenes de Trabajo</h3></header><div class="body"><span class="badge">Próxima etapa:</span> convertir cotización → OT, checklist de recepción, fotos, estatus, y mano de obra por técnico.</div></div>
    </section>
    <section id="page-clients" class="hidden">
      <div class="panel">
        <header>
          <h3>Clientes</h3>
          <button class="btn primary no-print right" id="btnAddNewClient">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"></path></svg>
            Nuevo Cliente
          </button>
        </header>
        <div class="body" id="clientsBody">
          <table class="table" id="mainClientsTable">
            <thead>
              <tr><th>Nombre</th><th>Correo</th><th>Teléfono</th><th>RFC</th></tr>
            </thead>
            <tbody><!-- Filas de clientes se insertarán aquí --></tbody>
          </table>
        </div>
      </div>
    </section>
    <section id="page-vehicles" class="hidden">
      <div class="panel">
        <header>
          <h3>Vehículos</h3>
          <button class="btn primary no-print right" id="btnAddNewVehicle">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"></path></svg>
            Nuevo Vehículo
          </button>
        </header>
        <div class="body">
          <table class="table" id="mainVehiclesTable">
            <thead>
              <tr>
                <th>Propietario</th>
                <th>Vehículo</th>
                <th>Color</th>
                <th>Placas</th>
                <th>VIN</th>
                <th class="no-print">Acciones</th>
              </tr>
            </thead>
            <tbody><!-- Vehicle rows will be inserted here --></tbody>
          </table>
        </div>
      </div>
    </section>
    <section id="page-inventory" class="hidden">
      <div class="panel">
        <header>
          <h3>Inventario de Productos</h3>
          <button class="btn primary no-print right" id="btnAddNewItem">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"></path></svg>
            Nuevo Producto
          </button>
        </header>
        <div class="body">
          <table class="table" id="inventoryTable">
            <thead>
              <tr>
                <th>SKU</th>
                <th>Descripción</th>
                <th>Proveedor</th>
                <th>Stock</th>
                <th>P. Compra</th>
                <th>P. Venta</th>
                <th class="no-print">Acciones</th>
              </tr>
            </thead>
            <tbody><!-- Inventory items will be inserted here --></tbody>
          </table>
        </div>
      </div>
    </section>
    <section id="page-payrolls" class="hidden">
      <div class="grid row-2" style="align-items: start;">
        <!-- Columna Izquierda: Generador y Resultados -->
        <div class="panel">
          <header><h3>Generar Nueva Nómina</h3></header>
          <div class="body">
            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr auto; align-items: end;">
              <div class="field">
                <label>Técnico</label>
                <select id="payrollTechSelect" class="input"></select>
              </div>
              <div class="field">
                <label>Fecha Inicio</label>
                <input type="date" class="input" id="payrollStartDate">
              </div>
              <div class="field">
                <label>Fecha Fin</label>
                <input type="date" class="input" id="payrollEndDate">
              </div>
              <button class="btn primary" id="calculatePayrollBtn">Calcular</button>
            </div>
            <hr class="sep" style="margin: 20px 0;">
            <div id="payrollResult" class="hidden">
              <h4>Resultado del Cálculo</h4>
              <div id="payrollResultData" style="margin-bottom: 15px;"></div>
              <button class="btn" id="savePayrollBtn">Guardar Nómina</button>
            </div>
          </div>
        </div>

        <!-- Columna Derecha: Configuración del Técnico -->
        <div class="panel">
          <header><h3>Configuración de Pago</h3></header>
          <div class="body" id="techConfigBody">
            <p class="muted" id="techConfigHelpText">Seleccione un técnico para ver o editar su configuración.</p>
            <form id="techConfigForm" class="hidden" onsubmit="return false;">
                <input type="hidden" id="configTechId">
                <div class="field">
                    <label>Tipo de Pago</label>
                    <select id="configPayType" class="input">
                        <option value="salario_fijo">Salario Fijo</option>
                        <option value="comision">Comisión</option>
                        <option value="mixto">Mixto</option>
                    </select>
                </div>
                <div class="field">
                    <label>Monto Salario Fijo ($)</label>
                    <input type="number" step="0.01" class="input" id="configSalary" placeholder="2000.00">
                </div>
                <div class="field">
                    <label>% de Comisión</label>
                    <input type="number" step="0.1" class="input" id="configCommission" placeholder="15.5">
                </div>
                <button class="btn primary" id="saveTechConfigBtn" style="margin-top: 10px;">Guardar Configuración</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Fila Inferior: Historial de Nóminas -->
      <div class="panel" style="margin-top: 16px;">
          <header><h3>Historial de Nóminas Guardadas</h3></header>
          <div class="body">
              <table class="table" id="payrollHistoryTable">
                  <thead>
                      <tr><th>Técnico</th><th>Periodo</th><th>Total Pagado</th><th>Fecha de Pago</th><th>Estatus</th></tr>
                  </thead>
                  <tbody><tr><td colspan="5">No hay registros de nómina.</td></tr></tbody>
              </table>
          </div>
      </div>
    </section>

    <section id="page-reports" class="hidden">
      <div class="grid row-2">
        <div class="panel">
          <header><h3>Ventas Mensuales (Último Año)</h3></header>
          <div class="body" style="height: 320px;">
            <canvas id="salesChart"></canvas>
          </div>
        </div>
        <div class="panel">
          <header><h3>Productos Más Vendidos (Mes Actual)</h3></header>
          <div class="body" style="height: 320px;">
            <canvas id="topProductsChart"></canvas>
          </div>
        </div>
      </div>
      <div class="panel" style="margin-top: 16px;">
        <header><h3>Servicios Más Solicitados (Mes Actual)</h3></header>
        <div class="body" style="height: 320px;">
          <canvas id="topServicesChart"></canvas>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- MODAL: Selección de cliente -->
<div class="modal-backdrop" id="modalClient">
  <div class="modal">
    <header>
      <strong>Seleccionar cliente</strong>
      <button class="btn ghost" onclick="closeModal('modalClient')">Cerrar</button>
    </header>
    <div class="content">
      <input class="input" id="clientSearch" placeholder="Buscar cliente…" />
      <table class="table" id="clientsTable">
        <thead><tr><th>Nombre</th><th>Correo</th><th>Teléfono</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="footer" style="justify-content: space-between;">
      <button class="btn primary" id="addNewClientFromQuoteBtn">Crear Nuevo Cliente</button>
      <button class="btn ghost" onclick="closeModal('modalClient')">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL: Formulario de Vehículo -->
<div class="modal-backdrop" id="modalVehicleForm">
  <div class="modal" style="width: min(1024px, 96vw);">
    <header>
      <strong id="vehicleModalTitle">Nuevo Vehículo</strong>
    </header>
    <div class="content">
      <form id="vehicleForm" onsubmit="return false;">
        <input type="hidden" id="vehicleId" value="">
        <div class="form-grid">
          <div class="field"><label>Propietario (Cliente)</label><select class="input" id="vehicleOwnerSelect" required></select></div>
          <div class="field"><label>Marca</label><input class="input" id="vehicleMake" placeholder="Ej. Nissan" required></div>
          <div class="field"><label>Modelo</label><input class="input" id="vehicleModel" placeholder="Ej. Versa" required></div>
          <div class="field"><label>Año</label><input class="input" id="vehicleYear" type="number" placeholder="Ej. 2020" required></div>
          <div class="field"><label>Color</label><input class="input" id="vehicleColor" placeholder="Ej. Rojo"></div>
          <div class="field"><label>Placas</label><input class="input" id="vehiclePlate" placeholder="ABC-123-A"></div>
          <div class="field"><label>VIN</label><input class="input" id="vehicleVIN" placeholder="17 caracteres"></div>
          <div class="field"><label>Kilometraje</label><input class="input" id="vehicleKM" type="number" placeholder="55000"></div>
        </div>
      </form>
    </div>
    <div class="footer">
      <button class="btn ghost" onclick="closeModal('modalVehicleForm')">Cancelar</button>
      <button class="btn primary" id="saveVehicleBtn">Guardar Vehículo</button>
    </div>
  </div>
</div>

<!-- MODAL: Formulario de Cliente -->
<div class="modal-backdrop" id="modalClientForm">
  <div class="modal">
    <header>
      <strong id="clientModalTitle">Nuevo Cliente</strong>
    </header>
    <div class="content">
      <form id="clientForm" onsubmit="return false;">
        <input type="hidden" id="clientId" value="">
        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
          <div class="field"><label>Nombre / Razón Social</label><input class="input" id="clientName" required></div>
          <div class="field"><label>Correo Electrónico</label><input class="input" id="clientEmail" type="email" required></div>
          <div class="field"><label>Teléfono</label><input class="input" id="clientPhone"></div>
          <div class="field"><label>RFC</label><input class="input" id="clientRFC"></div>
        </div>
        <div class="field" style="margin-top: 12px;"><label>Dirección</label><textarea class="input" id="clientAddress" rows="3"></textarea></div>
      </form>
    </div>
    <div class="footer">
      <button class="btn ghost" onclick="closeModal('modalClientForm')">Cancelar</button>
      <button class="btn primary" id="saveClientBtn">Guardar Cliente</button>
    </div>
  </div>
</div>

<!-- MODAL: Formulario de Inventario -->
<div class="modal-backdrop" id="modalInventory">
  <div class="modal">
    <header>
      <strong id="inventoryModalTitle">Nuevo Producto</strong>
    </header>
    <div class="content">
      <form id="inventoryForm" onsubmit="return false;">
        <input type="hidden" id="invItemId" value="">
        <div class="form-grid">
          <div class="field"><label>SKU</label><input class="input" id="invSKU" placeholder="Código de producto"></div>
          <div class="field"><label>Descripción</label><input class="input" id="invDesc" placeholder="Nombre o descripción" required></div>
          <div class="field"><label>Proveedor</label><input class="input" id="invProvider" placeholder="Nombre del proveedor"></div>
          <div class="field"><label>Stock Actual</label><input class="input" id="invStock" type="number" value="0" required></div>
          <div class="field"><label>Precio Compra</label><input class="input" id="invBuyPrice" type="number" step="0.01" placeholder="0.00"></div>
          <div class="field"><label>Precio Venta</label><input class="input" id="invSellPrice" type="number" step="0.01" placeholder="0.00" required></div>
          <div class="field"><label>Stock Mínimo</label><input class="input" id="invMinStock" type="number" value="0"></div>
        </div>
      </form>
    </div>
    <div class="footer">
      <button class="btn ghost" onclick="closeModal('modalInventory')">Cancelar</button>
      <button class="btn primary" id="saveInventoryItem">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL: Selección de vehículo -->
<div class="modal-backdrop" id="modalVehicle">
  <div class="modal">
    <header>
      <strong>Seleccionar vehículo</strong>
      <button class="btn ghost" onclick="closeModal('modalVehicle')">Cerrar</button>
    </header>
    <div class="content">
      <input class="input" id="vehicleSearch" placeholder="Buscar por placas, VIN o modelo…" />
      <table class="table" id="vehiclesTable">
        <thead><tr><th>Vehículo</th><th>Placas</th><th>VIN</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="footer" style="justify-content: space-between;">
      <button class="btn primary" id="addNewVehicleFromQuoteBtn">Crear Nuevo Vehículo</button>
      <button class="btn ghost" onclick="closeModal('modalVehicle')">Cancelar</button>
    </div>
  </div>
</div>

<script>
/* ---------- Utilities ---------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const money = (n, currency='MXN') => new Intl.NumberFormat('es-MX', {style:'currency', currency}).format(Number(n||0));
const todayISO = () => new Date().toISOString().slice(0,10);
const byId = id => document.getElementById(id);

/* ---------- Navigation ---------- */
$$('.nav a').forEach(a=>{
  a.addEventListener('click', e=>{
    e.preventDefault();
    $$('.nav a').forEach(n=>n.classList.remove('active'));
    a.classList.add('active');
    const page = a.dataset.page;
    $$('main > section').forEach(s=>s.classList.add('hidden'));
    byId('page-' + page).classList.remove('hidden');

    // --- Carga de datos dinámica al cambiar de página ---
    if (page === 'clients') {
      loadClientsPage();
    } else if (page === 'inventory') {
      loadInventoryPage();
    } else if (page === 'reports') {
      loadReportsPage();
    } else if (page === 'payrolls') {
      loadPayrollsPage();
    } else if (page === 'vehicles') {
      loadVehiclesPage();
    }
  });
});

/* ---------- Carga de Datos de Clientes (Página Principal) ---------- */
async function loadClientsPage() {
  const tbody = byId('mainClientsTable').querySelector('tbody');
  tbody.innerHTML = '<tr><td colspan="4">Cargando...</td></tr>';

  try {
    const response = await fetch('http://localhost:5001/api/clients');
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const clients = await response.json();

    if (clients.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4">No se encontraron clientes.</td></tr>';
      return;
    }

    tbody.innerHTML = clients.map(c => `
      <tr>
        <td>${c.nombre}</td>
        <td>${c.correo}</td>
        <td>${c.telefono || ''}</td>
        <td>${c.rfc || ''}</td>
      </tr>
    `).join('');
  } catch (error) {
    console.error('Error al cargar clientes:', error);
    tbody.innerHTML = '<tr><td colspan="4" style="color:var(--danger)">Error al cargar los clientes. Revise la consola.</td></tr>';
  }
}

/* ---------- Payrolls Page ---------- */
let lastPayrollCalc = {};

function setupPayrollEventListeners() {
    // Listener for technician selection change
    byId('payrollTechSelect').addEventListener('change', async (e) => {
        const userId = e.target.value;
        const configForm = byId('techConfigForm');
        const helpText = byId('techConfigHelpText');

        byId('payrollResult').classList.add('hidden');
        lastPayrollCalc = {};

        if (!userId) {
            configForm.classList.add('hidden');
            helpText.classList.remove('hidden');
            return;
        }

        try {
            const response = await fetch(`http://localhost:5001/api/mechanics/config/${userId}`);
            configForm.reset();
            byId('configTechId').value = userId;
            if (response.ok) {
                const config = await response.json();
                byId('configPayType').value = config.tipo_pago;
                byId('configSalary').value = config.monto_salario || '';
                byId('configCommission').value = config.porcentaje_comision || '';
            }
            helpText.classList.add('hidden');
            configForm.classList.remove('hidden');
        } catch (error) {
            console.error('Failed to load tech config', error);
            configForm.classList.add('hidden');
            helpText.classList.remove('hidden');
            helpText.textContent = 'No se pudo cargar la configuración.';
        }
    });

    // Listener for saving tech config
    byId('saveTechConfigBtn').addEventListener('click', async () => {
        const userId = byId('configTechId').value;
        if(!userId) return;
        const data = {
            tipo_pago: byId('configPayType').value,
            monto_salario: parseFloat(byId('configSalary').value) || null,
            porcentaje_comision: parseFloat(byId('configCommission').value) || null,
        };
        try {
            const response = await fetch(`http://localhost:5001/api/mechanics/config/${userId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!response.ok) throw new Error('Failed to save config');
            alert('Configuración guardada con éxito.');
        } catch (error) {
            alert('Error al guardar la configuración.');
            console.error(error);
        }
    });

    // Listener for calculating payroll
    byId('calculatePayrollBtn').addEventListener('click', async () => {
        const userId = byId('payrollTechSelect').value;
        const startDate = byId('payrollStartDate').value;
        const endDate = byId('payrollEndDate').value;

        if (!userId || !startDate || !endDate) {
            alert('Por favor, seleccione un técnico y un rango de fechas.');
            return;
        }

        const btn = byId('calculatePayrollBtn');
        btn.disabled = true;
        btn.textContent = 'Calculando...';
        byId('payrollResult').classList.add('hidden');

        try {
            const response = await fetch('http://localhost:5001/api/payrolls/calculate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, start_date: startDate, end_date: endDate })
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Calculation failed');

            lastPayrollCalc = { ...result, start_date: startDate, end_date: endDate }; // Cache the result

            const resultDiv = byId('payrollResultData');
            resultDiv.innerHTML = `
                <div class="tot-card" style="padding:10px; margin-top:10px;">
                  <div class="tot-row"><span>Técnico</span><strong>${result.tecnico_nombre}</strong></div>
                  <div class="tot-row"><span>Periodo</span><strong>${result.periodo}</strong></div>
                  <hr class="sep">
                  <div class="tot-row"><span>Salario Base</span><strong>${money(result.salario_base)}</strong></div>
                  <div class="tot-row"><span>Comisiones (${result.porcentaje_comision}%)</span><strong>${money(result.comisiones_ganadas)}</strong></div>
                  <hr class="sep">
                  <div class="tot-grand" style="font-size:18px"><span>Total a Pagar</span><span>${money(result.total_pagar)}</span></div>
                </div>
            `;
            byId('payrollResult').classList.remove('hidden');
        } catch (error) {
            alert(`Error al calcular la nómina: ${error.message}`);
            byId('payrollResult').classList.add('hidden');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Calcular';
        }
    });

    // Listener for saving the calculated payroll
    byId('savePayrollBtn').addEventListener('click', async () => {
        if (!lastPayrollCalc.user_id) {
            alert('Primero debe realizar un cálculo.');
            return;
        }

        const dataToSave = {
            user_id: lastPayrollCalc.user_id,
            start_date: lastPayrollCalc.start_date,
            end_date: lastPayrollCalc.end_date,
            salario_base: lastPayrollCalc.salario_base,
            comisiones_ganadas: lastPayrollCalc.comisiones_ganadas,
            total_pagar: lastPayrollCalc.total_pagar,
        };

        try {
            const response = await fetch('http://localhost:5001/api/payrolls', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSave)
            });
            if (!response.ok) throw new Error('Failed to save payroll');
            alert('Nómina guardada con éxito.');
            lastPayrollCalc = {}; // Clear cache
            byId('payrollResult').classList.add('hidden');
            loadPayrollHistory(); // Refresh history
        } catch (error) {
            alert('Error al guardar la nómina.');
            console.error(error);
        }
    });
}

async function loadPayrollHistory() {
    const tbody = byId('payrollHistoryTable').querySelector('tbody');
    tbody.innerHTML = '<tr><td colspan="5">Cargando historial...</td></tr>';
    try {
        const response = await fetch('http://localhost:5001/api/payrolls');
        const history = await response.json();

        if (history.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">No hay registros de nómina.</td></tr>';
            return;
        }

        tbody.innerHTML = history.map(p => `
            <tr>
                <td>${p.tecnico_nombre}</td>
                <td>${p.fecha_inicio_periodo.split('T')[0]} al ${p.fecha_fin_periodo.split('T')[0]}</td>
                <td>${money(p.total_pagar)}</td>
                <td>${new Date(p.fecha_generacion).toLocaleString()}</td>
                <td><span class="badge">${p.estatus}</span></td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Failed to load payroll history', error);
        tbody.innerHTML = '<tr><td colspan="5" style="color:var(--danger)">Error al cargar el historial.</td></tr>';
    }
}

async function loadPayrollsPage() {
    const techSelect = byId('payrollTechSelect');
    techSelect.innerHTML = '<option>Cargando técnicos...</option>';

    try {
        const response = await fetch('http://localhost:5001/api/users/technicians');
        const technicians = await response.json();
        techSelect.innerHTML = '<option value="">-- Seleccione un técnico --</option>';
        techSelect.innerHTML += technicians.map(t => `<option value="${t.id_usuario}">${t.nombre}</option>`).join('');
    } catch (error) {
        console.error('Failed to load technicians', error);
        techSelect.innerHTML = '<option>Error al cargar</option>';
    }

    // Set default dates (e.g., last month)
    const today = new Date();
    const firstDayLastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    const lastDayLastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
    byId('payrollStartDate').value = firstDayLastMonth.toISOString().slice(0,10);
    byId('payrollEndDate').value = lastDayLastMonth.toISOString().slice(0,10);

    loadPayrollHistory();
}
// Run once to attach listeners
setupPayrollEventListeners();


/* ---------- Client Form Management ---------- */
byId('btnAddNewClient').addEventListener('click', () => {
    byId('clientForm').reset();
    byId('clientModalTitle').textContent = 'Nuevo Cliente';
    byId('clientId').value = ''; // Ensure we are in "add" mode
    openModal('modalClientForm');
});

byId('saveClientBtn').addEventListener('click', async () => {
    const form = byId('clientForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const data = {
        nombre: byId('clientName').value,
        correo: byId('clientEmail').value,
        telefono: byId('clientPhone').value,
        rfc: byId('clientRFC').value,
        direccion: byId('clientAddress').value
    };

    // For now, we only support adding, not editing
    const url = '/api/clients';
    const method = 'POST';

    try {
        const response = await fetch(`http://localhost:5001${url}`, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.error || `HTTP error ${response.status}`);
        }

        closeModal('modalClientForm');
        loadClientsPage(); // Refresh the main client list

        // also refresh the list used in the quote modal
        allClients = [];
    } catch (error) {
        console.error('Error saving client:', error);
        alert(`No se pudo guardar el cliente: ${error.message}`);
    }
});


/* ---------- Vehicle Form Management ---------- */
async function populateVehicleOwnerSelect() {
    const select = byId('vehicleOwnerSelect');
    // Use cached client list if available
    if (allClients.length > 0) {
        select.innerHTML = allClients.map(c => `<option value="${c.id_cliente}">${c.nombre}</option>`).join('');
        return;
    }
    // Fetch if cache is empty
    try {
        const response = await fetch('http://localhost:5001/api/clients');
        allClients = await response.json();
        populateVehicleOwnerSelect(); // Recurse to populate from cache
    } catch (error) {
        console.error('Failed to load clients for vehicle form', error);
        select.innerHTML = '<option>Error al cargar clientes</option>';
    }
}

byId('btnAddNewVehicle').addEventListener('click', () => {
    byId('vehicleForm').reset();
    byId('vehicleModalTitle').textContent = 'Nuevo Vehículo';
    byId('vehicleId').value = '';
    populateVehicleOwnerSelect();
    openModal('modalVehicleForm');
});

async function loadVehiclesPage() {
    const tbody = byId('mainVehiclesTable').querySelector('tbody');
    tbody.innerHTML = '<tr><td colspan="6">Cargando vehículos...</td></tr>';
    try {
        const response = await fetch('http://localhost:5001/api/vehicles');
        const vehicles = await response.json();
        if (vehicles.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">No hay vehículos registrados.</td></tr>';
            return;
        }
        tbody.innerHTML = vehicles.map(v => `
            <tr data-item='${JSON.stringify(v)}'>
                <td>${v.nombre_cliente}</td>
                <td>${v.marca} ${v.modelo} ${v.anio}</td>
                <td>${v.color || ''}</td>
                <td>${v.placas || ''}</td>
                <td>${v.vin || ''}</td>
                <td class="no-print row-actions">
                    <button class="mini" onclick="editVehicle(this)">Editar</button>
                    <button class="mini" onclick="deleteVehicle(${v.id_vehiculo})">Borrar</button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error loading vehicles:', error);
        tbody.innerHTML = '<tr><td colspan="6" style="color:var(--danger)">Error al cargar vehículos.</td></tr>';
    }
}

function editVehicle(btn) {
    byId('vehicleForm').reset();
    byId('vehicleModalTitle').textContent = 'Editar Vehículo';
    populateVehicleOwnerSelect();

    const row = btn.closest('tr');
    const vehicleData = JSON.parse(row.dataset.item);

    byId('vehicleId').value = vehicleData.id_vehiculo;
    byId('vehicleOwnerSelect').value = vehicleData.cliente_id;
    byId('vehicleMake').value = vehicleData.marca;
    byId('vehicleModel').value = vehicleData.modelo;
    byId('vehicleYear').value = vehicleData.anio;
    byId('vehicleColor').value = vehicleData.color || '';
    byId('vehiclePlate').value = vehicleData.placas || '';
    byId('vehicleVIN').value = vehicleData.vin || '';
    byId('vehicleKM').value = vehicleData.km || '';

    openModal('modalVehicleForm');
}

async function deleteVehicle(id) {
    if (!confirm('¿Estás seguro de que quieres eliminar este vehículo?')) return;
    try {
        const response = await fetch(`http://localhost:5001/api/vehicles/${id}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Failed to delete');
        loadVehiclesPage(); // Refresh table
    } catch (error) {
        console.error('Error deleting vehicle:', error);
        alert('No se pudo eliminar el vehículo.');
    }
}

byId('saveVehicleBtn').addEventListener('click', async () => {
    const form = byId('vehicleForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const vehicleId = byId('vehicleId').value;
    const data = {
        cliente_id: byId('vehicleOwnerSelect').value,
        marca: byId('vehicleMake').value,
        modelo: byId('vehicleModel').value,
        anio: byId('vehicleYear').value,
        color: byId('vehicleColor').value,
        placas: byId('vehiclePlate').value,
        vin: byId('vehicleVIN').value,
        km: byId('vehicleKM').value
    };

    const url = vehicleId ? `http://localhost:5001/api/vehicles/${vehicleId}` : 'http://localhost:5001/api/vehicles';
    const method = vehicleId ? 'PUT' : 'POST';

    try {
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.error || `HTTP error ${response.status}`);
        }
        closeModal('modalVehicleForm');
        loadVehiclesPage();
    } catch (error) {
        console.error('Error saving vehicle:', error);
        alert(`No se pudo guardar el vehículo: ${error.message}`);
    }
});


/* ---------- Reports Page ---------- */
let salesChartInstance;
let topProductsChartInstance;
let topServicesChartInstance;

async function loadReportsPage() {
    // Destroy previous chart instances if they exist to prevent flickering
    if (salesChartInstance) salesChartInstance.destroy();
    if (topProductsChartInstance) topProductsChartInstance.destroy();
    if (topServicesChartInstance) topServicesChartInstance.destroy();

    // Fetch and render all charts
    renderSalesChart();
    renderTopItemsChart('refaccion', 'topProductsChart', 'Productos');
    renderTopItemsChart('mano_obra', 'topServicesChart', 'Servicios');
}

async function renderSalesChart() {
    const ctx = byId('salesChart').getContext('2d');
    try {
        const response = await fetch('http://localhost:5001/api/reports/sales?period=monthly');
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();

        salesChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(row => row.period),
                datasets: [{
                    label: 'Ventas Totales',
                    data: data.map(row => row.total_sales),
                    backgroundColor: 'rgba(37, 99, 235, 0.6)',
                    borderColor: 'rgba(37, 99, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } }
            }
        });
    } catch (error) {
        console.error('Error rendering sales chart:', error);
        ctx.font = "14px Inter";
        ctx.fillStyle = "var(--muted)";
        ctx.textAlign = "center";
        ctx.fillText("No se pudieron cargar los datos del gráfico.", 150, 100);
    }
}

async function renderTopItemsChart(type, canvasId, label) {
    const ctx = byId(canvasId).getContext('2d');
    try {
        const response = await fetch(`http://localhost:5001/api/reports/top-items?type=${type}`);
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();

        const chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.map(row => row.descripcion),
                datasets: [{
                    label: `Top ${label}`,
                    data: data.map(row => row.total_quantity),
                    backgroundColor: ['#3B82F6','#8B5CF6','#EC4899','#10B981','#F59E0B','#6366F1','#D946EF','#06B6D4','#14B8A6','#F97316'],
                    borderWidth: 0,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'right' } }
            }
        });

        if (canvasId === 'topProductsChart') {
            topProductsChartInstance = chartInstance;
        } else {
            topServicesChartInstance = chartInstance;
        }
    } catch (error) {
        console.error(`Error rendering top ${label} chart:`, error);
        ctx.font = "14px Inter";
        ctx.fillStyle = "var(--muted)";
        ctx.textAlign = "center";
        ctx.fillText("No se pudieron cargar los datos del gráfico.", 150, 100);
    }
}


/* ---------- Inventory Management ---------- */
async function loadInventoryPage() {
    const tbody = byId('inventoryTable').querySelector('tbody');
    tbody.innerHTML = '<tr><td colspan="7">Cargando inventario...</td></tr>';

    try {
        const response = await fetch('http://localhost:5001/api/inventory');
        if (!response.ok) throw new Error(`HTTP error! ${response.status}`);
        const items = await response.json();

        if (items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7">No hay productos en el inventario.</td></tr>';
            return;
        }

        tbody.innerHTML = items.map(item => `
            <tr data-item='${JSON.stringify(item)}'>
                <td>${item.sku || ''}</td>
                <td>${item.descripcion}</td>
                <td>${item.proveedor || ''}</td>
                <td>${item.stock}</td>
                <td>${money(item.precio_compra)}</td>
                <td>${money(item.precio_venta)}</td>
                <td class="no-print row-actions">
                    <button class="mini" onclick="editInventoryItem(this)">Editar</button>
                    <button class="mini" onclick="deleteInventoryItem(${item.id_producto})">Borrar</button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error loading inventory:', error);
        tbody.innerHTML = '<tr><td colspan="7" style="color:var(--danger)">Error al cargar el inventario.</td></tr>';
    }
}

function resetInventoryForm() {
    byId('inventoryModalTitle').textContent = 'Nuevo Producto';
    byId('inventoryForm').reset();
    byId('invItemId').value = '';
}

byId('btnAddNewItem').addEventListener('click', () => {
    resetInventoryForm();
    openModal('modalInventory');
});

function editInventoryItem(btn) {
    resetInventoryForm();
    byId('inventoryModalTitle').textContent = 'Editar Producto';

    const row = btn.closest('tr');
    const itemData = JSON.parse(row.dataset.item);

    byId('invItemId').value = itemData.id_producto;
    byId('invSKU').value = itemData.sku || '';
    byId('invDesc').value = itemData.descripcion;
    byId('invProvider').value = itemData.proveedor || '';
    byId('invStock').value = itemData.stock;
    byId('invBuyPrice').value = itemData.precio_compra || '';
    byId('invSellPrice').value = itemData.precio_venta;
    byId('invMinStock').value = itemData.stock_minimo || 0;

    openModal('modalInventory');
}

async function deleteInventoryItem(id) {
    if (!confirm('¿Estás seguro de que quieres eliminar este producto?')) {
        return;
    }
    try {
        const response = await fetch(`http://localhost:5001/api/inventory/${id}`, { method: 'DELETE' });
        if (!response.ok) throw new Error(`HTTP error! ${response.status}`);
        loadInventoryPage(); // Refresh table
    } catch (error) {
        console.error('Error deleting item:', error);
        alert('No se pudo eliminar el producto.');
    }
}

byId('saveInventoryItem').addEventListener('click', async () => {
    const form = byId('inventoryForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const itemId = byId('invItemId').value;
    const data = {
        sku: byId('invSKU').value,
        descripcion: byId('invDesc').value,
        proveedor: byId('invProvider').value,
        stock: parseInt(byId('invStock').value, 10),
        precio_compra: parseFloat(byId('invBuyPrice').value) || null,
        precio_venta: parseFloat(byId('invSellPrice').value),
        stock_minimo: parseInt(byId('invMinStock').value, 10) || 0,
    };

    const url = itemId ? `http://localhost:5001/api/inventory/${itemId}` : 'http://localhost:5001/api/inventory';
    const method = itemId ? 'PUT' : 'POST';

    try {
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.error || `HTTP error! ${response.status}`);
        }

        closeModal('modalInventory');
        loadInventoryPage(); // Refresh table
    } catch (error) {
        console.error('Error saving item:', error);
        alert(`No se pudo guardar el producto: ${error.message}`);
    }
});

/* ---------- Theme toggle ---------- */
byId('toggleTheme').addEventListener('click', ()=>{
  const root = document.documentElement;
  root.dataset.theme = (root.dataset.theme === 'light' ? 'dark' : 'light');
});

/* ---------- Keyboard: global search focus ---------- */
document.addEventListener('keydown', (e)=>{
  if(e.key === '/'){ e.preventDefault(); byId('globalSearch').focus(); }
});

/* ---------- Demo Data (Vehicles and Quotes are still static) ---------- */
const demoVehicles = [
  {veh:'Nissan Versa 2019', plate:'XBC-329-A', vin:'3N1CN7AD4KL123456', km: 54432},
  {veh:'Toyota Hilux 2021', plate:'WLK-77-22', vin:'MR0KB3CD8M0123456', km: 81200},
  {veh:'VW Jetta 2017', plate:'UYY-902-B', vin:'3VW267AJ3HM123456', km: 120322}
];
const demoQuotes = [
  {folio:'AUT-0005', client:'Transportes MX', veh:'Hilux 2021', date:'2025-08-21', total: 18750.55, status:'Enviada'},
  {folio:'AUT-0004', client:'Juan Pérez', veh:'Versa 2019', date:'2025-08-20', total: 4820.00, status:'Aceptada'},
  {folio:'AUT-0003', client:'María López', veh:'Jetta 2017', date:'2025-08-18', total: 9320.70, status:'Vencida'}
];

/* ---------- Dashboard binds ---------- */
function loadDashboard(){
  const tbody = byId('quotesTable').querySelector('tbody');
  tbody.innerHTML = demoQuotes.map(q=>`
    <tr>
      <td>${q.folio}</td>
      <td>${q.client}</td>
      <td>${q.veh}</td>
      <td>${q.date}</td>
      <td>${money(q.total)}</td>
      <td><span class="badge">${q.status}</span></td>
    </tr>
  `).join('');
  byId('kpiIngresos').textContent = money(demoQuotes.reduce((s,q)=>s+q.total,0));
  byId('kpiOrdenes').textContent = '8';
}
loadDashboard();

/* ---------- Clients & Vehicles modals ---------- */
let allClients = []; // Cache for clients to use in modals and searches

function openModal(id){ byId(id).style.display='grid'; }
function closeModal(id){ byId(id).style.display='none'; }

async function populateClientModal() {
  const tbody = byId('clientsTable').querySelector('tbody');

  // Render from cache if it's already populated
  if (allClients.length > 0) {
    tbody.innerHTML = allClients.map((c, i) => `
      <tr>
        <td>${c.nombre}</td><td>${c.correo}</td><td>${c.telefono || ''}</td>
        <td><button class="btn ghost mini" data-idx="${i}" onclick="selectClientFromModal(${i})">Elegir</button></td>
      </tr>
    `).join('');
    return;
  }

  // Fetch from API if cache is empty
  tbody.innerHTML = '<tr><td colspan="4">Cargando...</td></tr>';
  try {
    const response = await fetch('http://localhost:5001/api/clients');
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    allClients = await response.json(); // Populate cache

    // If cache is now populated, run the function again to render from cache
    if (allClients.length > 0) {
      populateClientModal();
    } else {
      tbody.innerHTML = '<tr><td colspan="4">No se encontraron clientes.</td></tr>';
    }
  } catch (error) {
    console.error('Error populating client modal:', error);
    tbody.innerHTML = '<tr><td colspan="4" style="color:var(--danger)">Error al cargar los clientes.</td></tr>';
  }
}

byId('btnSelectClient').addEventListener('click', ()=>{
  populateClientModal();
  openModal('modalClient');
});

window.selectClientFromModal = (idx)=>{
  const c = allClients[idx];
  if (!c) return;
  byId('qCliente').value = c.nombre;
  byId('qEmail').value = c.correo;
  byId('qPhone').value = c.telefono || '';
  byId('qRFC').value = c.rfc || '';
  closeModal('modalClient');
}

byId('btnSelectVehicle').addEventListener('click', ()=>{
  const tbody = byId('vehiclesTable').querySelector('tbody');
  tbody.innerHTML = demoVehicles.map((v,i)=>`
    <tr>
      <td>${v.veh}</td><td>${v.plate}</td><td>${v.vin}</td>
      <td><button class="btn ghost mini" onclick="selectVehicle(${i})">Elegir</button></td>
    </tr>
  `).join('');
  openModal('modalVehicle');
});
window.selectVehicle = (i)=>{
  const v = demoVehicles[i];
  byId('qVehiculo').value = v.veh;
  byId('qPlacas').value = v.plate;
  byId('qVIN').value = v.vin;
  byId('qKM').value = v.km;
  closeModal('modalVehicle');
}

/* ---------- Quotes page init ---------- */
function initQuoteForm(){
  byId('qFecha').value = todayISO();
  if(!byId('qFolio').value) byId('qFolio').value = nextFolio();
  addItem({type:'Refacción', desc:'Filtro de aceite', qty:1, price:220, disc:0, iva:true});
  addItem({type:'Mano de Obra', desc:'Servicio menor', qty:1, price:850, disc:0, iva:true});
  recalcTotals();
}
function nextFolio(){
  const n = Number(localStorage.getItem('folioSeq') || '5') + 1;
  localStorage.setItem('folioSeq', String(n));
  return `AUT-${String(n).padStart(4,'0')}`;
}

/* ---------- Items table ---------- */
const tbodyItems = byId('itemsTable').querySelector('tbody');
function addItem(pref={}){
  const row = document.createElement('tr');
  row.innerHTML = `
    <td>
      <select class="item-type">
        <option${pref.type==='Refacción'?' selected':''}>Refacción</option>
        <option${pref.type==='Mano de Obra'?' selected':''}>Mano de Obra</option>
      </select>
    </td>
    <td><input class="input item-desc" placeholder="Descripción" value="${pref.desc||''}"></td>
    <td><input class="input item-qty" type="number" min="0" step="0.01" value="${pref.qty??1}"></td>
    <td><input class="input item-price" type="number" min="0" step="0.01" value="${pref.price??0}"></td>
    <td><input class="input item-disc" type="number" min="0" max="100" step="0.1" value="${pref.disc??0}"></td>
    <td>
      <select class="item-iva">
        <option value="16"${pref.iva!==false?' selected':''}>IVA 16%</option>
        <option value="0"${pref.iva===false?' selected':''}>Exento</option>
      </select>
    </td>
    <td class="item-total" style="text-align:right">${money(0)}</td>
    <td class="row-actions no-print" style="text-align:center">
      <button class="mini" onclick="dupRow(this)">Duplicar</button>
      <button class="mini" onclick="delRow(this)">Eliminar</button>
    </td>
  `;
  tbodyItems.appendChild(row);
  row.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', recalcTotals));
  recalcTotals();
}
function rowData(tr){
  return {
    type: tr.querySelector('.item-type').value,
    desc: tr.querySelector('.item-desc').value.trim(),
    qty: Number(tr.querySelector('.item-qty').value)||0,
    price: Number(tr.querySelector('.item-price').value)||0,
    disc: Number(tr.querySelector('.item-disc').value)||0,
    ivaRate: Number(tr.querySelector('.item-iva').value)||0
  };
}
function calcRow(r){
  const gross = r.qty * r.price;
  const discVal = gross * (r.disc/100);
  const net = Math.max(0, gross - discVal);
  const iva = net * (r.ivaRate/100);
  const total = net + iva;
  return {gross, discVal, net, iva, total};
}
function recalcTotals(){
  let subtotal=0, discTotal=0, ivaTotal=0, grand=0;
  $$('#itemsTable tbody tr').forEach(tr=>{
    const d = rowData(tr);
    const c = calcRow(d);
    subtotal += d.qty * d.price;
    discTotal += c.discVal;
    ivaTotal += c.iva;
    grand += c.total;
    tr.querySelector('.item-total').textContent = money(c.total, byId('qMoneda').value);
  });
  byId('tSubtotal').textContent = money(subtotal, byId('qMoneda').value);
  byId('tDescuento').textContent = money(discTotal, byId('qMoneda').value);
  byId('tIVA').textContent = money(ivaTotal, byId('qMoneda').value);
  byId('tTotal').textContent = money(grand, byId('qMoneda').value);
}
window.dupRow = (btn)=>{ const tr = btn.closest('tr'); const d = rowData(tr); addItem({ ...d, iva: d.ivaRate!==0 }); }
window.delRow = (btn)=>{ const tr = btn.closest('tr'); tr.remove(); recalcTotals(); }

byId('addItemBtn').addEventListener('click', ()=> addItem({}));

/* ---------- Save / POST ---------- */
byId('saveQuote').addEventListener('click', ()=>{
  const data = collectQuoteData();
  const key = `quote:${data.folio}`;
  localStorage.setItem(key, JSON.stringify(data));
  alert('Cotización guardada localmente: ' + key);
  // Add to dashboard demo list
  demoQuotes.unshift({folio:data.folio, client:data.cliente, veh:data.vehiculo, date:data.fecha, total:data.totales.total, status:'Borrador'});
  loadDashboard();
});

byId('postBackend').addEventListener('click', async ()=>{
  const data = collectQuoteData();
  if (data.items.length === 0) {
    alert('No se puede generar una cotización sin items.');
    return;
  }

  try{
    const res = await fetch('http://localhost:5001/api/quotes/pdf', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    if(!res.ok) {
      const errText = await res.text();
      throw new Error(`Error del servidor: ${res.status} ${res.statusText}. Detalles: ${errText}`);
    }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `${data.folio || 'cotizacion'}.pdf`; a.click();
    URL.revokeObjectURL(url);
  }catch(err){
    console.error('Error al generar PDF:', err);
    alert(`No se pudo generar el PDF.\nError: ${err.message}`);
  }
});

/* ---------- Export demo (Print CSS) ---------- */
byId('exportDemo').addEventListener('click', ()=> {
  // Switch to quotes page if not there, to print the content
  $$('.nav a').forEach(n=>n.classList.remove('active'));
  $$('main > section').forEach(s=>s.classList.add('hidden'));
  $('[data-page="quotes"]').classList.add('active');
  byId('page-quotes').classList.remove('hidden');
  window.print();
});

/* ---------- Collect form ---------- */
function collectQuoteData(){
  const items = $$('#itemsTable tbody tr').map(tr=>{
    const d = rowData(tr); const c = calcRow(d);
    return { ...d, ...c };
  });
  const tot = {
    subtotal: items.reduce((s,i)=>s+i.qty*i.price,0),
    descuento: items.reduce((s,i)=>s+i.discVal,0),
    iva: items.reduce((s,i)=>s+i.iva,0),
    total: items.reduce((s,i)=>s+i.total,0)
  };
  return {
    folio: byId('qFolio').value || nextFolio(),
    fecha: byId('qFecha').value || todayISO(),
    validez: Number(byId('qValidez').value)||7,
    moneda: byId('qMoneda').value,
    cliente: byId('qCliente').value,
    rfc: byId('qRFC').value,
    email: byId('qEmail').value,
    telefono: byId('qPhone').value,
    vehiculo: byId('qVehiculo').value,
    placas: byId('qPlacas').value,
    vin: byId('qVIN').value,
    km: byId('qKM').value,
    notas: byId('qNotas').value,
    condiciones: byId('qCond').value,
    items, totales: tot
  };
}

/* ---------- Quote Flow Improvements ---------- */
byId('addNewClientFromQuoteBtn').addEventListener('click', () => {
    closeModal('modalClient');
    byId('btnAddNewClient').click(); // Reuse existing logic
});

byId('addNewVehicleFromQuoteBtn').addEventListener('click', () => {
    closeModal('modalVehicle');
    byId('btnAddNewVehicle').click(); // Reuse existing logic
});


/* ---------- Route helpers ---------- */
byId('newQuoteBtn').addEventListener('click', ()=>{
  $$('.nav a').forEach(n=>n.classList.remove('active'));
  $('[data-page="quotes"]').classList.add('active');
  $$('main > section').forEach(s=>s.classList.add('hidden'));
  byId('page-quotes').classList.remove('hidden');
});

/* ---------- Init ---------- */
initQuoteForm();
</script>
</body>
</html>
